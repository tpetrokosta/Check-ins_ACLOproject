---
title: "check-ins visualizations"
output: html_document
date: "2026-01-18"
---
Data cleaning
```{r}
library(tidyverse)
library(lubridate)
library(knitr)


setwd("/Users/brechtdevries/Downloads")

fitness_2324 <- read_delim(
  "2023-2024 fitness ingang bezoek.csv",
  delim = ";",
  show_col_types = FALSE
)

fitness_2425 <- read_delim(
  "2024-2025 fitness ingang bezoek.csv",
  delim = ";",
  show_col_types = FALSE
)

balie_2324 <- read_delim(
  "2023-2024 balie ingang.csv",
  delim = ";",
  show_col_types = FALSE
)

balie_2425 <- read_delim(
  "2024-2025 balie ingang.csv",
  delim = ";",
  show_col_types = FALSE
)

# Cleaning 
clean_data <- function(df, period_label, source_label) {
  df %>%
    mutate(
      Incheckdatum = dmy_hm(Incheckdatum),
      hour = hour(Incheckdatum) + minute(Incheckdatum) / 60,
      period = period_label,
      source = source_label,
      time_block = case_when(
        hour >= 7.25 & hour < 7.75 ~ "07:15–07:45",
        hour >= 7.75 & hour < 17   ~ "07:45–17:00",
        hour >= 17   & hour < 22   ~ "17:00–22:00",
        hour >= 22   & hour <= 23  ~ "22:00–23:00",
        TRUE ~ NA_character_
      )
    ) %>%
    filter(!is.na(time_block))
}

# Combine and clean  datasets
fitness_clean <- bind_rows(
  clean_data(fitness_2324, "Before (2023–2024)", "Fitness"),
  clean_data(fitness_2425, "After (2024–2025)", "Fitness")
)

balie_clean <- bind_rows(
  clean_data(balie_2324, "Before (2023–2024)", "Balie"),
  clean_data(balie_2425, "After (2024–2025)", "Balie")
)

all_data <- bind_rows(fitness_clean, balie_clean)

# Counts per time block
counts <- all_data %>%
  group_by(source, period, time_block) %>%
  summarise(visits = n(), .groups = "drop")

# Fix: Ensure all combinations exist even if zero visits
all_combinations <- expand.grid(
  source = unique(counts$source),
  period = unique(counts$period),
  time_block = c(
    "07:15–07:45",
    "07:45–17:00",
    "17:00–22:00",
    "22:00–23:00"
  ),
  stringsAsFactors = FALSE
)

counts_complete <- all_combinations %>%
  left_join(counts, by = c("source", "period", "time_block")) %>%
  mutate(visits = replace_na(visits, 0))

# Calculate percentages and set factor order for plotting and table
distribution <- counts_complete %>%
  group_by(source, period) %>%
  mutate(percentage = visits / sum(visits) * 100) %>%
  ungroup() %>%
  mutate(
    period = factor(
      period,
      levels = c("Before (2023–2024)", "After (2024–2025)")
    ),
    time_block = factor(
      time_block,
      levels = c(
        "07:15–07:45",
        "07:45–17:00",
        "17:00–22:00",
        "22:00–23:00"
      )
    )
  )
```

```{r}
ggplot(distribution, aes(x = time_block, y = percentage, fill = period)) +
  geom_col(position = "dodge") +
  facet_wrap(~ source) +
  labs(
    title = "Distribution of check-ins before and after earlier opening",
    x = "Time block",
    y = "Percentage of visits"
  ) +
  theme_minimal()
```

Table 2.1: Absolute number of check-ins per time block, before and after earlier opening (Balie and Fitness)
```{r}
### TABLE ###

# Print table
kable(
  table_absolute,
  caption = "Absolute number of check-ins per time block, before and after earlier opening (Balie and Fitness)",
  col.names = c(
    "Location",
    "Time block",
    "Before (2023–2024)",
    "After (2024–2025)"
  )
)

counts_complete <- counts_complete %>%
  mutate(
    period = factor(
      period,
      levels = c("Before (2023–2024)", "After (2024–2025)")
    ),
    time_block = factor(
      time_block,
      levels = c(
        "07:15–07:45",
        "07:45–17:00",
        "17:00–22:00",
        "22:00–23:00"
      )
    )
  )

```

```{r}
# Plot: absolute check-ins per time block
ggplot(counts_complete, aes(x = time_block, y = visits, fill = period)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  facet_wrap(~ source) +
  labs(
    title = "Number of Balie and Fitness check-ins per time block",
    subtitle = "Before vs after earlier opening time",
    x = "Time block",
    y = "Number of check-ins",
    fill = "Period"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    strip.text = element_text(face = "bold")
  )
```

Figure 2.2: Distribution of check-ins in the four time blocks, shown as percentages of total check-ins, for Balie and Fitness entrances, plotted for 2023-2024 against 2024-2025
```{r}
###### graph 2
#  correct ordering 
distribution <- distribution %>%
  mutate(
    period = factor(
      period,
      levels = c("Before (2023–2024)", "After (2024–2025)")
    ),
    time_block = factor(
      time_block,
      levels = c(
        "07:15–07:45",
        "07:45–17:00",
        "17:00–22:00",
        "22:00–23:00"
      )
    )
  )

# Plot: 100% stacked bars 
ggplot(distribution, aes(x = period, y = percentage, fill = time_block)) +
  geom_col(width = 0.7) +
  facet_wrap(~ source) +
  labs(
    title = "Distribution of check-ins across time blocks",
    subtitle = "Before vs after earlier opening time",
    x = NULL,
    y = "Percentage of check-ins",
    fill = "Time block"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold")
  )
```

Figure 2.3: Number of Fitness check-ins by time of day (2023-2024 vs. 2024-2025)
```{r}
ibrary(dplyr)
library(lubridate)
library(ggplot2)


fitness_5min <- fitness_clean %>%
  mutate(
    time_5min = floor_date(Incheckdatum, unit = "5 minutes"),
    time_of_day = format(time_5min, "%H:%M")
  ) %>%
  group_by(period, time_of_day) %>%
  summarise(checkins = n(), .groups = "drop") %>%
  filter(time_of_day >= "07:15", time_of_day <= "23:00") %>%
  arrange(time_of_day) %>%
  mutate(
    time_of_day = factor(time_of_day, levels = unique(time_of_day))
  )


x_breaks <- c(
  "07:15", "07:45",
  "17:00", "22:00",
  "23:00"
)

x_labels <- c(
  "07:15", "07:45",
  "17:00", "22:00",
  "23:00"
)


ggplot(
  fitness_5min,
  aes(x = time_of_day, y = checkins, color = period, group = period)
) +
  geom_line(linewidth = 0.8, alpha = 0.7) +
  scale_x_discrete(
    breaks = x_breaks,
    labels = x_labels
  ) +
  labs(
    title = "Fitness check-ins by time of day",
    subtitle = "Before vs after earlier opening time",
    x = "Time of day",
    y = "Number of check-ins",
    color = "Period"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 8),
    legend.position = "right"
  )
```

Group lessons and spinning - Data cleaning
```{r}
library(dplyr)
library(lubridate)
library(readr)
library(ggplot2)



groepslessen_2324 <- read_delim(
  "groepslessen overdag en spinning 23-24.csv",
  delim = ";",
  show_col_types = FALSE
)

groepslessen_2425 <- read_delim(
  "groepslessen overdag en spinning 24-25.csv",
  delim = ";",
  show_col_types = FALSE
)

#### clean


clean_groepslessen <- function(df, period_label) {
  df %>%
    mutate(
      Incheckdatum = dmy_hm(Incheckdatum),
      hour = hour(Incheckdatum) + minute(Incheckdatum) / 60,
      period = period_label,
      time_block = case_when(
        hour >= 7.25 & hour < 7.75 ~ "07:15–07:45",
        hour >= 7.75 & hour < 17   ~ "07:45–17:00",
        hour >= 17   & hour < 22   ~ "17:00–22:00",
        hour >= 22   & hour <= 23  ~ "22:00–23:00",
        TRUE ~ NA_character_
      )
    ) %>%
    filter(!is.na(time_block))
}



groepslessen_all <- bind_rows(
  clean_groepslessen(groepslessen_2324, "Before (2023–2024)"),
  clean_groepslessen(groepslessen_2425, "After (2024–2025)")
)


timeblock_counts <- groepslessen_all %>%
  count(period, time_block, name = "checkins") %>%
  mutate(
    period = factor(
      period,
      levels = c("Before (2023–2024)", "After (2024–2025)")
    ),
    time_block = factor(
      time_block,
      levels = c(
        "07:15–07:45",
        "07:45–17:00",
        "17:00–22:00",
        "22:00–23:00"
      )
    )
  )

```

Figure 2.4: Number of check-ins per time block, for group lessons & spinning, (2023-2024 vs 2024-2025)
```{r}
#### GRAPH

ggplot(timeblock_counts, aes(x = time_block, y = checkins, fill = period)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = "Group lessons & spinning: check-ins by time block",
    subtitle = "Before vs after earlier opening time",
    x = "Time block",
    y = "Number of check-ins",
    fill = "Period"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 9)
  )
```

Table 2.2: Percentage of check-ins per time block, before and after earlier opening (Balie and Fitness)
```{r}
### TABLE ###

library(tidyr)
library(knitr)

checkins_table <- timeblock_counts %>%
  pivot_wider(
    names_from = period,
    values_from = checkins
  ) %>%
  arrange(time_block)


kable(
  checkins_table,
  caption = "Group lessons & spinning: number of check-ins per time block (before vs after earlier opening)"
)
```

